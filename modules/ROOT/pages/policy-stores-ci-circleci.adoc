= Policy Stores: CI with CircleCI

This guide will help you set up a CI/CD pipeline in CircleCI to automatically upload your Cerbos policies to a Cerbos Hub Store whenever you push changes to the `main` branch of your Git repository.

== Prerequisites
* A CircleCI account, linked to your GitHub or Bitbucket account.
* Your repository "set up" as a project in CircleCI.
* Your `CERBOS_HUB_CLIENT_ID` and `CERBOS_HUB_CLIENT_SECRET` values.
* Your Policy Store ID

== Step 1: Create the Config File
. In your repository, create a directory named `.circleci`.
. Inside `.circleci`, create a file named `config.yml`.
. Copy and paste the following code into it:
. Replace `[STORE_ID]` with the ID of your Cerbos Hub Store. You can find this in the Cerbos Hub UI under the Store settings.

[source,yaml]
----
# .circleci/config.yml
version: 2.1

jobs:
  upload-policies:
    docker:
      - image: cimg/base:2024.01
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Upload Policies
          command: |
            docker run --rm \
              -e CERBOS_HUB_STORE_ID="[STORE_ID]" \
              -e CERBOS_HUB_CLIENT_ID=$CERBOS_HUB_CLIENT_ID \
              -e CERBOS_HUB_CLIENT_SECRET=$CERBOS_HUB_CLIENT_SECRET \
              -v "$(pwd)":/app \
              ghcr.io/cerbos/cerbosctl:latest \
              hub store replace-files /app --message="Policy upload from CircleCI"

workflows:
  build-and-upload:
    jobs:
      - upload-policies:
          filters:
            branches:
              only: main
----

== Step 2: Add Your Secrets
. Go to the CircleCI dashboard and select your project.
. Click *Project Settings* in the upper right.
. In the sidebar, click *Environment Variables*.
. Click *Add Environment Variable*.
. Enter `CERBOS_HUB_CLIENT_ID` as the *Name* and paste your client ID as the *Value*. Click *Add Environment Variable*.
. Repeat for `CERBOS_HUB_CLIENT_SECRET`.

== Step 3: Commit and Push
. Commit the `.circleci/config.yml` file.
. Push your changes to the `main` branch.

== Step 4: Verify the Run
. Go to your project's dashboard in CircleCI.
. You will see a new workflow running. Click on it to see the status of the `upload-policies` job.
